# Third-Party Service Category Management

## Overview

Third-party services now automatically create and manage their own **categories** with associated **cookies**. This provides a cleaner architecture where:
- **ThirdPartyService** â†’ creates â†’ **CookieCategory** â†’ contains â†’ **Cookies**
- Categories and cookies are auto-generated and read-only
- Manual categories remain fully editable
- Clear visual distinction between auto-generated and manual content

## Architecture

### Entity Relationships

```
CookiePolicy
    â”œâ”€â”€ CookieCategory (manual)
    â”‚   â””â”€â”€ Cookie[]
    â”œâ”€â”€ CookieCategory (auto-generated) â†â”€â”€â”
    â”‚   â””â”€â”€ Cookie[] (auto-generated)      â”‚
    â””â”€â”€ ThirdPartyService â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â””â”€â”€ category (OneToOne)
```

### Key Changes

1. **ThirdPartyService** has `OneToOne` relationship with **CookieCategory**
2. **CookieCategory** has inverse `OneToOne` with **ThirdPartyService**
3. **Cookie** determines if auto-generated through its category
4. Cascade delete: Service deletion â†’ Category deletion â†’ Cookies deletion

## Database Schema

### ThirdPartyService Entity

```php
#[ORM\OneToOne(targetEntity: CookieCategory::class, cascade: ['persist', 'remove'])]
#[ORM\JoinColumn(nullable: true, onDelete: 'CASCADE')]
private ?CookieCategory $category = null;
```

**Migration SQL**:
```sql
ALTER TABLE masilia_third_party_service 
ADD COLUMN category_id INT DEFAULT NULL UNIQUE,
ADD CONSTRAINT FK_service_category 
    FOREIGN KEY (category_id) 
    REFERENCES masilia_cookie_category(id) 
    ON DELETE CASCADE;
```

### CookieCategory Entity

```php
#[ORM\OneToOne(targetEntity: ThirdPartyService::class, mappedBy: 'category')]
private ?ThirdPartyService $thirdPartyService = null;

public function isAutoGenerated(): bool
{
    return $this->thirdPartyService !== null;
}
```

### Cookie Entity

```php
public function isAutoGenerated(): bool
{
    return $this->category && $this->category->isAutoGenerated();
}
```

## Automatic Lifecycle Management

### 1. Service Creation â†’ Category + Cookies Created

**Event**: `ThirdPartyServiceSubscriber::postPersist()`

**Process**:
1. Service created with preset (e.g., "google_analytics")
2. New category created:
   - `identifier`: `{service_identifier}_category`
   - `name`: Service name
   - `description`: From preset
   - `position`: 999 (end of list)
3. Cookies created from preset and added to category
4. Category linked to service via `OneToOne`

**Example**:
```
Service: "Google Analytics" (preset: google_analytics)
    â†“
Category: "Google Analytics" (auto-generated)
    â”œâ”€â”€ Cookie: _ga (2 years)
    â”œâ”€â”€ Cookie: _gid (24 hours)
    â””â”€â”€ Cookie: _gat (1 minute)
```

### 2. Service Update â†’ Category + Cookies Updated

**Event**: `ThirdPartyServiceSubscriber::postUpdate()`

**Process**:
1. Service preset changed (e.g., from "google_analytics" to "hotjar")
2. Category name and description updated
3. All existing cookies removed
4. New cookies created from new preset
5. Category remains linked to service

**Example**:
```
Before: Google Analytics â†’ [_ga, _gid, _gat]
After:  Hotjar â†’ [_hjSessionUser_*, _hjSession_*]
```

### 3. Service Deletion â†’ Category + Cookies Deleted

**Process**:
1. Service deleted
2. Cascade delete removes category (via `cascade: ['remove']`)
3. Cascade delete removes all cookies (via category's `orphanRemoval: true`)

## Read-Only Protection

### Controller Level

#### CategoryAdminController

```php
public function edit(Request $request, CookieCategory $category): Response
{
    if ($category->isAutoGenerated()) {
        $this->addFlash('error', 'Cannot edit auto-generated categories...');
        return $this->redirectToRoute(...);
    }
    // ... normal edit logic
}

public function delete(Request $request, CookieCategory $category): Response
{
    if ($category->isAutoGenerated()) {
        $this->addFlash('error', 'Cannot delete auto-generated categories...');
        return $this->redirectToRoute(...);
    }
    // ... normal delete logic
}
```

#### CookieAdminController

```php
public function edit(Request $request, Cookie $cookie): Response
{
    if ($cookie->isAutoGenerated()) {
        $this->addFlash('error', 'Cannot edit auto-generated cookies...');
        return $this->redirectToRoute(...);
    }
    // ... normal edit logic
}

public function delete(Request $request, Cookie $cookie): Response
{
    if ($cookie->isAutoGenerated()) {
        $this->addFlash('error', 'Cannot delete auto-generated cookies...');
        return $this->redirectToRoute(...);
    }
    // ... normal delete logic
}
```

### UI Level

#### Category Display

**Auto-Generated Category**:
```twig
{% if category.isAutoGenerated %}
    <span class="ibexa-badge ibexa-badge--info">
        <svg class="ibexa-icon ibexa-icon--system-information"></svg>
        Auto-Generated
    </span>
{% endif %}
```

**Category Actions**:
```twig
{% if not category.isAutoGenerated %}
    <!-- Edit, Delete, Add Cookie buttons -->
{% else %}
    <span class="ibexa-label">
        <svg class="ibexa-icon ibexa-icon--lock"></svg>
        Read-only
    </span>
{% endif %}
```

#### Cookie Display

**Auto-Generated Cookie**:
```twig
<code>{{ cookie.name }}</code>
{% if cookie.isAutoGenerated %}
    <span class="ibexa-badge ibexa-badge--info">Auto</span>
{% endif %}
```

**Cookie Actions**:
```twig
{% if not cookie.isAutoGenerated %}
    <!-- Edit and Delete buttons -->
{% else %}
    <span class="ibexa-label">
        <svg class="ibexa-icon ibexa-icon--lock"></svg>
    </span>
{% endif %}
```

### Form Generation

```php
// PolicyAdminController::view()
foreach ($policy->getCategories() as $category) {
    // Skip auto-generated categories
    if ($category->isAutoGenerated()) {
        continue;
    }
    
    // Create forms only for manual categories
    $editCategoryForms[$category->getId()] = ...;
    $addCookieForms[$category->getId()] = ...;
    $editCookieForms[$category->getId()] = ...;
}
```

### Modal Rendering

```twig
{% for category in policy.categories %}
    {% if not category.isAutoGenerated %}
        {# Edit and Delete modals #}
    {% endif %}
{% endfor %}

{% for cookie in category.cookies %}
    {% if not cookie.isAutoGenerated %}
        {# Edit and Delete modals #}
    {% endif %}
{% endfor %}
```

## Visual Indicators

### Category List

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Google Analytics [Auto-Generated â„¹ï¸] [Required] [ðŸ”’ Read-only] â”‚
â”‚ â”œâ”€â”€ _ga [Auto â„¹ï¸]                                  [ðŸ”’] â”‚
â”‚ â”œâ”€â”€ _gid [Auto â„¹ï¸]                                 [ðŸ”’] â”‚
â”‚ â””â”€â”€ _gat [Auto â„¹ï¸]                                 [ðŸ”’] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Analytics [Required]                    [âœŽ] [ðŸ—‘] [+ Cookie] â”‚
â”‚ â”œâ”€â”€ custom_cookie                              [âœŽ] [ðŸ—‘] â”‚
â”‚ â””â”€â”€ another_cookie                             [âœŽ] [ðŸ—‘] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Workflow Examples

### Example 1: Create Service with Preset

**User Action**: Add "Facebook Pixel" service with preset

**System Response**:
1. Service created: `facebook_pixel` with preset `facebook_pixel`
2. Category auto-created:
   - Name: "Facebook Pixel"
   - Identifier: "facebook_pixel_category"
   - Description: "Analytics tool that helps measure..."
3. Cookies auto-created:
   - `_fbp` (3 months)
   - `fr` (3 months)
4. Category appears with "Auto-Generated" badge
5. Edit/Delete buttons hidden, "Read-only" label shown

### Example 2: Edit Service Preset

**User Action**: Edit service, change preset from "Google Analytics" to "Google Tag Manager"

**System Response**:
1. Category name updated to "Google Tag Manager"
2. Old cookies deleted: `_ga`, `_gid`, `_gat`
3. New cookies created: `_ga`, `_gid` (GTM versions)
4. Category remains auto-generated
5. User sees updated cookie list automatically

### Example 3: Delete Service

**User Action**: Delete "Hotjar" service

**System Response**:
1. Service deleted from database
2. Category "Hotjar" automatically deleted (cascade)
3. All cookies (`_hjSessionUser_*`, `_hjSession_*`) deleted (cascade)
4. Manual categories and cookies unaffected

### Example 4: Attempt to Edit Auto-Generated Category

**User Action**: Try to click edit button on auto-generated category

**System Response**:
1. Edit button not visible (hidden by template)
2. "Read-only" label displayed instead
3. If accessed via direct URL:
   - Controller blocks with `isAutoGenerated()` check
   - Flash error: "Cannot edit auto-generated categories..."
   - Redirected to policy view

## Translation Keys

Add to `masilia_consent.en.yaml`:

```yaml
category:
  auto_generated: 'Auto-Generated'
  auto_generated.tooltip: 'Auto-generated from third-party service'
  auto_generated.read_only: 'This category is managed by the third-party service'
  read_only: 'Read-only'

cookie:
  auto_generated: 'Auto'
  auto_generated.tooltip: 'Auto-generated from third-party service'
  auto_generated.read_only: 'This cookie is managed by the third-party service'
```

## Benefits

1. **Cleaner Architecture**: Service â†’ Category â†’ Cookies hierarchy
2. **Automatic Management**: No manual cookie entry for services
3. **Data Integrity**: Categories and cookies always match service presets
4. **Clear Ownership**: Visual distinction between manual and auto-generated
5. **Safety**: Cannot accidentally modify service-managed content
6. **Maintenance**: Service updates propagate to categories and cookies
7. **Flexibility**: Manual categories still fully editable

## Migration Path

### For Existing Data

If you have existing third-party services without categories:

```php
// Migration script
foreach ($services as $service) {
    if (!$service->getCategory() && $service->getPresetType()) {
        // Trigger category creation
        $subscriber->postPersist(new PostPersistEventArgs($service, $em));
    }
}
```

### Database Migration

```bash
php bin/console doctrine:migrations:diff
php bin/console doctrine:migrations:migrate
```

## Testing Checklist

- [ ] Create service with preset â†’ category and cookies created
- [ ] Category shows "Auto-Generated" badge
- [ ] Category actions show "Read-only" label
- [ ] Cookies show "Auto" badge
- [ ] Cookie actions show lock icon
- [ ] Edit service preset â†’ category and cookies updated
- [ ] Delete service â†’ category and cookies deleted
- [ ] Cannot edit auto-generated category (UI blocked)
- [ ] Cannot delete auto-generated category (UI blocked)
- [ ] Cannot edit auto-generated cookie (UI blocked)
- [ ] Cannot delete auto-generated cookie (UI blocked)
- [ ] Direct URL edit blocked with error message
- [ ] Direct URL delete blocked with error message
- [ ] Manual categories still editable
- [ ] Manual cookies still editable
- [ ] Mixed content (auto + manual) displays correctly
- [ ] No modals rendered for auto-generated content

---

**Implemented**: November 2025
**Architecture**: Service â†’ Category â†’ Cookies
