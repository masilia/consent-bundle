# Auto-Generated Cookies from Third-Party Services

## Overview

Cookies are now automatically created, updated, and deleted when third-party services with presets are managed. These auto-generated cookies are read-only and cannot be manually edited or deleted.

## Database Schema Changes

### Cookie Entity - New Field

Added `thirdPartyService` relationship to track auto-generated cookies:

```php
#[ORM\ManyToOne(targetEntity: ThirdPartyService::class)]
#[ORM\JoinColumn(nullable: true, onDelete: 'CASCADE')]
private ?ThirdPartyService $thirdPartyService = null;
```

**Migration Required**: Run `php bin/console doctrine:migrations:diff` to generate migration.

```sql
ALTER TABLE masilia_cookie 
ADD COLUMN third_party_service_id INT DEFAULT NULL,
ADD CONSTRAINT FK_cookie_service 
    FOREIGN KEY (third_party_service_id) 
    REFERENCES masilia_third_party_service(id) 
    ON DELETE CASCADE;
```

## Features

### 1. Automatic Cookie Creation

When a third-party service with a preset is **created**:
- Event: `ThirdPartyServiceSubscriber::postPersist()`
- Cookies from preset are automatically created
- Linked to the service via `thirdPartyService` field
- Assigned to the category specified in the service

**Example**: Creating a "Google Analytics" service automatically creates:
- `_ga` cookie (2 years)
- `_gid` cookie (24 hours)
- `_gat` cookie (1 minute)

### 2. Automatic Cookie Update

When a third-party service is **edited**:
- Event: `ThirdPartyServiceSubscriber::postUpdate()`
- All existing auto-generated cookies are removed
- New cookies are created from the updated preset

**Use Case**: Changing service preset from "Google Analytics" to "Google Tag Manager" replaces all cookies.

### 3. Automatic Cookie Deletion

When a third-party service is **deleted**:
- Event: `ThirdPartyServiceSubscriber::preRemove()`
- All auto-generated cookies are automatically deleted
- Cascade delete via database constraint

### 4. Read-Only Protection

Auto-generated cookies cannot be manually modified:

#### Controller Protection
```php
// CookieAdminController::edit()
if ($cookie->isAutoGenerated()) {
    $this->addFlash('error', 'Cannot edit auto-generated cookies...');
    return $this->redirectToRoute(...);
}

// CookieAdminController::delete()
if ($cookie->isAutoGenerated()) {
    $this->addFlash('error', 'Cannot delete auto-generated cookies...');
    return $this->redirectToRoute(...);
}
```

#### UI Protection
- Edit/Delete buttons hidden for auto-generated cookies
- Lock icon displayed instead
- "Auto" badge shown on cookie name
- No edit/delete modals rendered

## UI/UX

### Cookie Table Display

**Manual Cookie**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ _custom     â”‚ Provider â”‚ Purpose     â”‚ Expiry â”‚ [âœŽ] [ðŸ—‘] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Auto-Generated Cookie**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”
â”‚ _ga [Auto â„¹ï¸]    â”‚ Google Anal. â”‚ Purpose     â”‚ 2 yrs  â”‚ [ðŸ”’] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜
```

### Visual Indicators

1. **Badge**: Blue "Auto" badge next to cookie name
   - Tooltip: "Auto-generated from third-party service"
   
2. **Lock Icon**: Replaces edit/delete buttons
   - Tooltip: "This cookie is managed by the third-party service"

3. **No Modals**: Edit/delete modals not rendered for auto-generated cookies

## Code Changes

### 1. Cookie Entity (`Cookie.php`)

**Added**:
```php
private ?ThirdPartyService $thirdPartyService = null;

public function getThirdPartyService(): ?ThirdPartyService
public function setThirdPartyService(?ThirdPartyService $service): self
public function isAutoGenerated(): bool  // Returns true if linked to service
```

### 2. ThirdPartyServiceSubscriber

**Updated Events**:
- `postPersist` - Create cookies on service creation
- `postUpdate` - Replace cookies on service update (NEW)
- `preRemove` - Delete cookies on service deletion (NEW)

**New Method**:
```php
private function removeServiceCookies(ThirdPartyService $service): void
{
    $cookies = $this->entityManager->getRepository(Cookie::class)
        ->findBy(['thirdPartyService' => $service]);
    
    foreach ($cookies as $cookie) {
        $this->entityManager->remove($cookie);
    }
    
    $this->entityManager->flush();
}
```

**Updated Method**:
```php
private function createCookiesFromPreset(ThirdPartyService $service): void
{
    // ...
    $cookie->setThirdPartyService($service);  // Link to service
    // ...
}
```

### 3. CookieAdminController

**Protection Added**:
- `edit()` - Check `isAutoGenerated()` before allowing edit
- `delete()` - Check `isAutoGenerated()` before allowing delete

### 4. PolicyAdminController

**Form Generation**:
```php
foreach ($category->getCookies() as $cookie) {
    // Skip auto-generated cookies
    if (!$cookie->isAutoGenerated()) {
        $editCookieForms[$category->getId()][$cookie->getId()] = ...;
    }
}
```

### 5. View Template (`view_refactored.html.twig`)

**Cookie Name Column**:
```twig
{% set cookie_name %}
    <code>{{ cookie.name }}</code>
    {% if cookie.isAutoGenerated %}
        <span class="ibexa-badge ibexa-badge--info" 
              title="{{ 'cookie.auto_generated.tooltip'|trans }}">
            {{ 'cookie.auto_generated'|trans }}
        </span>
    {% endif %}
{% endset %}
```

**Actions Column**:
```twig
{% set actions_col %}
    {% if not cookie.isAutoGenerated %}
        <!-- Edit and Delete buttons -->
    {% else %}
        <span class="ibexa-label" 
              title="{{ 'cookie.auto_generated.read_only'|trans }}">
            <svg class="ibexa-icon ibexa-icon--lock">...</svg>
        </span>
    {% endif %}
{% endset %}
```

**Modal Rendering**:
```twig
{% for cookie in category.cookies %}
    {% if not cookie.isAutoGenerated %}
        <!-- Edit and Delete modals -->
    {% endif %}
{% endfor %}
```

## Translation Keys

Add to `masilia_consent.en.yaml`:

```yaml
cookie:
  auto_generated: 'Auto'
  auto_generated.tooltip: 'Auto-generated from third-party service'
  auto_generated.read_only: 'This cookie is managed by the third-party service'
```

## Workflow Examples

### Example 1: Create Service with Preset

**Action**: Create "Facebook Pixel" service
**Result**:
1. Service saved to database
2. `postPersist` event triggered
3. Preset cookies created:
   - `_fbp` â†’ linked to service
   - `fr` â†’ linked to service
4. Cookies appear in category table with "Auto" badge

### Example 2: Edit Service Preset

**Action**: Change service from "Google Analytics" to "Hotjar"
**Result**:
1. Service updated in database
2. `postUpdate` event triggered
3. Old cookies removed:
   - `_ga` deleted
   - `_gid` deleted
   - `_gat` deleted
4. New cookies created:
   - `_hjSessionUser_*` â†’ linked to service
   - `_hjSession_*` â†’ linked to service

### Example 3: Delete Service

**Action**: Delete "Facebook Pixel" service
**Result**:
1. `preRemove` event triggered
2. Auto-generated cookies deleted:
   - `_fbp` removed
   - `fr` removed
3. Service deleted from database
4. Manual cookies in same category remain untouched

### Example 4: Attempt to Edit Auto-Generated Cookie

**Action**: Click edit button on `_ga` cookie
**Result**:
1. Button is hidden (not clickable)
2. Lock icon displayed instead
3. If accessed directly via URL:
   - Controller check prevents edit
   - Flash error message shown
   - Redirected back to policy view

## Benefits

1. **Consistency**: Cookies always match service presets
2. **Automation**: No manual cookie entry for common services
3. **Accuracy**: Preset data from official documentation
4. **Maintenance**: Updates propagate automatically
5. **Safety**: Cannot accidentally modify service cookies
6. **Clarity**: Visual distinction between manual and auto cookies

## Testing Checklist

- [ ] Create service with preset â†’ cookies created
- [ ] Edit service preset â†’ cookies replaced
- [ ] Delete service â†’ cookies deleted
- [ ] Auto-generated cookies show "Auto" badge
- [ ] Auto-generated cookies show lock icon
- [ ] Edit button hidden for auto-generated cookies
- [ ] Delete button hidden for auto-generated cookies
- [ ] No edit modal for auto-generated cookies
- [ ] No delete modal for auto-generated cookies
- [ ] Direct edit URL blocked with error message
- [ ] Direct delete URL blocked with error message
- [ ] Manual cookies still editable/deletable
- [ ] Mixed cookies (auto + manual) display correctly

## Future Enhancements

1. **Sync Button**: Manually trigger cookie sync for a service
2. **Preset Updates**: Notify when preset definitions change
3. **Bulk Operations**: Update all services using same preset
4. **Audit Log**: Track cookie changes from service updates
5. **Preview**: Show cookies before creating service

---

**Implemented**: November 2025
