{% extends '@ibexadesign/ui/layout.html.twig' %}

{% trans_default_domain 'masilia_consent' %}
{% import _self as macros %}

{% block body_class %}ibexa-consent-policy-view{% endblock %}

{% block breadcrumbs %}
    {% include '@ibexadesign/ui/breadcrumbs.html.twig' with { items: [
        { value: 'breadcrumb.admin'|trans(domain='messages')|desc('Admin') },
        { value: 'policy.list.title'|trans|desc('Cookie Policies'), url: path('masilia_consent_admin_policy_list') },
        { value: policy.version }
    ]} %}
{% endblock %}

{% block title %}{{ 'policy.view.title'|trans({'%version%': policy.version})|desc('Policy %version%') }}{% endblock %}

{% block header %}
    {% embed '@ibexadesign/ui/page_title.html.twig' with {
        title: 'policy.view.title'|trans|desc('Cookie Policy'),
    } %}
        {% block bottom %}
            <span class="ibexa-icon-tag">
                {{ 'policy.view.list.version'|trans({'%version%': policy.version})|desc('Version: %version%') }}
            </span>
        {% endblock %}
    {% endembed %}
{% endblock %}

{% block context_menu %}
    {% set menu_items %}
        <li class="ibexa-context-menu__item ibexa-adaptive-items__item">
            <a
                    href="{{ path('masilia_consent_admin_policy_list') }}"
                    class="btn ibexa-btn ibexa-btn--tertiary"
            >
                <svg class="ibexa-icon ibexa-icon--small">
                    <use xlink:href="{{ ibexa_icon_path('back') }}"></use>
                </svg>
                <span class="ibexa-btn__label">
                    {{ 'policy.back_to_list'|trans|desc('Back to list') }}
                </span>
            </a>
        </li>
        <li class="ibexa-context-menu__item ibexa-adaptive-items__item">
            <a
                    href="{{ path('masilia_consent_admin_policy_edit', {id: policy.id}) }}"
                    class="btn ibexa-btn ibexa-btn--secondary"
            >
                <svg class="ibexa-icon ibexa-icon--small ibexa-icon--edit">
                    <use xlink:href="{{ ibexa_icon_path('edit') }}"></use>
                </svg>
                <span class="ibexa-btn__label">
                    {{ 'policy.edit'|trans|desc('Edit') }}
                </span>
            </a>
        </li>
        {% if not policy.isActive %}
            <li class="ibexa-context-menu__item ibexa-adaptive-items__item">
                <button
                        type="button"
                        class="btn ibexa-btn ibexa-btn--primary"
                        data-bs-toggle="modal"
                        data-bs-target="#activate-policy"
                >
                    <svg class="ibexa-icon ibexa-icon--small">
                        <use xlink:href="{{ ibexa_icon_path('checkmark') }}"></use>
                    </svg>
                    <span class="ibexa-btn__label">
                        {{ 'policy.activate'|trans|desc('Activate') }}
                    </span>
                </button>
            </li>
        {% endif %}
    {% endset %}

    {{ include('@ibexadesign/ui/component/context_menu/context_menu.html.twig', {
        menu_items: menu_items,
    }) }}
{% endblock %}

{% block content %}
    <div class="container ibexa-container">
        {# Policy Information Section #}
        {% block policy_information %}
            {% set version_content %}
                <strong>{{ policy.version }}</strong>
                {% if policy.isActive %}
                    <span class="ibexa-badge ibexa-badge--success">{{ 'policy.status.active'|trans|desc('Active') }}</span>
                {% endif %}
            {% endset %}

            {% set cookie_prefix_content %}
                <code>{{ policy.cookiePrefix }}</code>
            {% endset %}

            {% set policy_properties_items = [
                {
                    label: 'policy.version'|trans|desc('Version'),
                    content_raw: version_content,
                },
                {
                    label: 'policy.last_updated'|trans|desc('Last Updated'),
                    content: policy.lastUpdated|date('Y-m-d H:i:s'),
                },
                {
                    label: 'policy.cookie_prefix'|trans|desc('Cookie Prefix'),
                    content_raw: cookie_prefix_content,
                },
                {
                    label: 'policy.expiration_days'|trans|desc('Expiration Days'),
                    content: policy.expirationDays ~ ' ' ~ ('policy.days'|trans|desc('days')),
                },
                {
                    label: 'policy.site_access'|trans|desc('Site Access'),
                    content: policy.siteAccess ?: ('policy.all_sites'|trans|desc('All Sites')),
                },
            ] %}


            {% include '@ibexadesign/ui/component/details/details.html.twig' with {
                headline: 'policy.information'|trans()|desc('Policy Information'),
                items: policy_properties_items,
            } only %}
        {% endblock %}

        {# Categories Section #}
        {% block categories_section %}
            <section class="ibexa-fieldgroup">
                <div class="ibexa-fieldgroup__header">
                    <h2 class="ibexa-edit-header__name">{{ 'policy.categories'|trans()|desc('Categories') }}</h2>
                    {{ macros.add_category_button(policy) }}
                </div>

                <div class="ibexa-fieldgroup__content">
                    {% for category in policy.categories %}
                        {% set status %}
                            {% if category.isAutoGenerated %}
                                <span class="ibexa-badge ibexa-badge--info" title="{{ 'category.auto_generated.tooltip'|trans|desc('Auto-generated from third-party service') }}">
                                    <svg class="ibexa-icon ibexa-icon--small">
                                        <use xlink:href="{{ ibexa_icon_path('system-information') }}"></use>
                                    </svg>
                                    {{ 'category.auto_generated'|trans|desc('Auto-Generated') }}
                                </span>
                            {% endif %}
                            {% if category.required %}
                                <span class="ibexa-badge ibexa-badge--warning">{{ 'category.required'|trans|desc('Required') }}</span>
                            {% endif %}
                            {% if category.defaultEnabled %}
                                <span class="ibexa-badge ibexa-badge--complementary">{{ 'category.default_enabled'|trans|desc('Default Enabled') }}</span>
                            {% endif %}
                        {% endset %}

                        {% block between_header_and_table %}
                            <div class="ibexa-table-sub-header">
                                {{ status }}
                            </div>
                        {% endblock %}


                        {% include '@ibexadesign/ui/component/table/table_header.html.twig' with {
                            headline: 'category.cookies_count'|trans({
                                '%count%': category.cookies|length,
                                '%name%': category.name,
                            })|desc('%name% (%count% cookies)'),
                            actions: macros.category_header_tools(category),
                            show_notice: true,
                            notice_message: category.description ,
                        } only %}


                        {% if category.cookies is not empty %}
                            {% set cookie_body_rows = [] %}
                            {% for cookie in category.cookies %}
                                {% set cookie_name %}
                                    <code>{{ cookie.name }}</code>
                                    {% if cookie.isAutoGenerated %}
                                        <span class="ibexa-badge ibexa-badge--info" title="{{ 'cookie.auto_generated.tooltip'|trans|desc('Auto-generated from third-party service') }}">
                                            {{ 'cookie.auto_generated'|trans|desc('Auto') }}
                                        </span>
                                    {% endif %}
                                {% endset %}
                                
                                {% set actions_col %}
                                    {% if not cookie.isAutoGenerated %}
                                        <a
                                            href="{{ path('masilia_consent_admin_cookie_edit', {id: cookie.id}) }}"
                                            class="btn ibexa-btn ibexa-btn--ghost ibexa-btn--no-text"
                                            title="{{ 'common.edit'|trans()|desc('Edit') }}">
                                            <svg class="ibexa-icon ibexa-icon--small ibexa-icon--edit">
                                                <use xlink:href="{{ ibexa_icon_path('edit') }}"></use>
                                            </svg>
                                        </a>
                                        <button
                                            type="button"
                                            class="btn ibexa-btn ibexa-btn--ghost ibexa-btn--no-text"
                                            data-bs-toggle="modal"
                                            data-bs-target="#delete-cookie-{{ cookie.id }}"
                                            title="{{ 'common.delete'|trans()|desc('Delete') }}">
                                            <svg class="ibexa-icon ibexa-icon--small ibexa-icon--trash">
                                                <use xlink:href="{{ ibexa_icon_path('trash') }}"></use>
                                            </svg>
                                        </button>
                                    {% else %}
                                        <span class="ibexa-label" title="{{ 'cookie.auto_generated.read_only'|trans|desc('This cookie is managed by the third-party service') }}">
                                            <svg class="ibexa-icon ibexa-icon--small ibexa-icon--lock">
                                                <use xlink:href="{{ ibexa_icon_path('lock') }}"></use>
                                            </svg>
                                        </span>
                                    {% endif %}
                                {% endset %}
                                
                                {% set cookie_row_cols = [
                                    { content: cookie_name, raw: true },
                                    { content: cookie.provider },
                                    { content: cookie.purpose },
                                    { content: cookie.expiry },
                                    { content: actions_col, raw: true, has_action_btns: true },
                                ] %}
                                {% set cookie_body_rows = cookie_body_rows|merge([{ cols: cookie_row_cols }]) %}
                            {% endfor %}

                            {% include '@ibexadesign/ui/component/table/table.html.twig' with {
                                head_cols: [
                                    { content: 'cookie.name'|trans()|desc('Name') },
                                    { content: 'cookie.provider'|trans()|desc('Provider') },
                                    { content: 'cookie.purpose'|trans()|desc('Purpose') },
                                    { content: 'cookie.expiry'|trans()|desc('Expiry') },
                                    { },
                                ],
                                body_rows: cookie_body_rows,
                            } %}
                        {% else %}
                            {% include '@ibexadesign/ui/component/alert/alert.html.twig' with {
                                type: 'info',
                                title: 'category.no_cookies'|trans|desc('No cookies defined for this category yet.'),
                            } only %}
                        {% endif %}
                    {% endfor %}
                </div>
            </section>

            {% if policy.categories is empty %}
                <section>
                    {% include '@ibexadesign/ui/component/table/table_header.html.twig' with {
                        headline: 'policy.categories'|trans()|desc('Categories'),
                        actions: macros.add_category_button(policy),
                    } %}
                    {% include '@ibexadesign/ui/component/alert/alert.html.twig' with {
                        type: 'info',
                        title: 'policy.no_categories'|trans|desc('No categories defined yet. Add a category to get started.'),
                    } only %}
                </section>
            {% endif %}
        {% endblock %}

        {# Third-Party Services Section #}
        {% block services_section %}
            <section class="ibexa-fieldgroup">
                <div class="ibexa-fieldgroup__content">
                {% include '@ibexadesign/ui/component/table/table_header.html.twig' with {
                    headline: 'policy.third_party_services'|trans({'%count%': policy.thirdPartyServices|length})|desc('Third-Party Services (%count%)'),
                    actions: macros.add_service_button(policy),
                } %}

                {% if policy.thirdPartyServices is not empty %}
                    {% set service_body_rows = [] %}
                    {% for service in policy.thirdPartyServices %}
                        {% set name_col %}
                            <strong>{{ service.name }}</strong>
                        {% endset %}

                        {% set preset_col %}
                            {% if service.presetType %}
                                <small class="ibexa-badge ibexa-badge--info">{{ service.presetType }}</small>
                            {% endif %}
                        {% endset %}

                        {% set category_col %}
                            {{ service.category }}
                        {% endset %}

                        {% set status_col %}
                            {% if service.enabled %}
                                <span class="ibexa-badge ibexa-badge--success">{{ 'common.enabled'|trans|desc('Enabled') }}</span>
                            {% else %}
                                <span class="ibexa-badge ibexa-badge--secondary">{{ 'common.disabled'|trans|desc('Disabled') }}</span>
                            {% endif %}
                        {% endset %}

                        {% set actions_col %}
                            <a
                                    href="{{ path('masilia_consent_admin_service_edit', {id: service.id}) }}"
                                    class="btn ibexa-btn ibexa-btn--ghost ibexa-btn--no-text"
                                    title="{{ 'common.edit'|trans()|desc('Edit') }}">
                                <svg class="ibexa-icon ibexa-icon--small ibexa-icon--edit">
                                    <use xlink:href="{{ ibexa_icon_path('edit') }}"></use>
                                </svg>
                            </a>
                            <button
                                    type="button"
                                    class="btn ibexa-btn ibexa-btn--ghost ibexa-btn--no-text"
                                    data-bs-toggle="modal"
                                    data-bs-target="#delete-service-{{ service.id }}"
                                    title="{{ 'common.delete'|trans()|desc('Delete') }}">
                                <svg class="ibexa-icon ibexa-icon--small ibexa-icon--trash">
                                    <use xlink:href="{{ ibexa_icon_path('trash') }}"></use>
                                </svg>
                            </button>
                        {% endset %}

                        {% set service_row_cols = [
                            { content: name_col, raw: true },
                            { content: preset_col, raw: true },
                            { content: category_col, raw: true },
                            { content: service.identifier },
                            { content: status_col, raw: true },
                            { content: actions_col, raw: true, has_action_btns: true },
                        ] %}
                        {% set service_body_rows = service_body_rows|merge([{ cols: service_row_cols }]) %}
                    {% endfor %}

                    {% include '@ibexadesign/ui/component/table/table.html.twig' with {
                        head_cols: [
                            { content: 'third_party_service.list.name'|trans()|desc('Name') },
                            { content: 'third_party_service.list.preset'|trans()|desc('Preset') },
                            { content: 'third_party_service.list.category'|trans()|desc('Category') },
                            { content: 'third_party_service.list.identifier'|trans()|desc('Identifier') },
                            { content: 'third_party_service.list.status'|trans()|desc('Status') },
                            { content: 'common.actions'|trans()|desc('Actions'), has_icon_col: true },
                            { },
                        ],
                        body_rows: service_body_rows,
                    } %}
                {% else %}
                    {% include '@ibexadesign/ui/component/alert/alert.html.twig' with {
                        type: 'info',
                        title: 'third_party_service.no_services'|trans|desc('No third-party services configured. Add services like Google Analytics, Facebook Pixel, etc. to automatically manage cookies and scripts.'),
                    } only %}
                {% endif %}
                </div>
            </section>
        {% endblock %}
    </div>

    {# Modals - Only for delete confirmations #}
    {% block modals %}
        {# Delete Category Modals #}
        {% for category in policy.categories %}
            {% if not category.isAutoGenerated %}
                {# Delete Category Modal #}
                {% embed '@ibexadesign/ui/component/modal/modal.html.twig' with {
                    class: 'ibexa-modal--send-to-trash',
                    no_header: true,
                    id: 'delete-category-' ~ category.id,
                } %}
                    {% block body_content %}
                        <p>{{ 'category.delete.message'|trans({'%name%': category.name})|desc('Delete category "%name%"? This will also delete all associated cookies. This action cannot be undone.') }}</p>
                    {% endblock %}
                    {% block footer_content %}
                        <form method="post" action="{{ path('masilia_consent_admin_category_delete', {id: category.id}) }}"
                              class="d-inline">
                            <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ category.id) }}">
                            <button type="submit" class="btn ibexa-btn ibexa-btn--danger">
                                <svg class="ibexa-icon ibexa-icon--small">
                                    <use xlink:href="{{ ibexa_icon_path('trash') }}"></use>
                                </svg>
                                {{ 'common.delete'|trans()|desc('Delete') }}
                            </button>
                        </form>
                        <button type="button" class="btn ibexa-btn ibexa-btn--secondary" data-bs-dismiss="modal">
                            {{ 'common.cancel'|trans()|desc('Cancel') }}
                        </button>
                    {% endblock %}
                {% endembed %}
            {% endif %}
        {% endfor %}

        {# Delete Service Modals #}
        {% for service in policy.thirdPartyServices %}
            {# Delete Service Modal #}
            {% embed '@ibexadesign/ui/component/modal/modal.html.twig' with {
                class: 'ibexa-modal--send-to-trash',
                no_header: true,
                id: 'delete-service-' ~ service.id,
            } %}
                {% block body_content %}
                    <p>{{ 'third_party_service.delete.message'|trans({'%name%': service.name})|desc('Delete service "%name%"? This action cannot be undone.') }}</p>
                {% endblock %}
                {% block footer_content %}
                    <form method="post" action="{{ path('masilia_consent_admin_service_delete', {id: service.id}) }}"
                          class="d-inline">
                        <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ service.id) }}">
                        <button type="submit" class="btn ibexa-btn ibexa-btn--danger">
                            <svg class="ibexa-icon ibexa-icon--small">
                                <use xlink:href="{{ ibexa_icon_path('trash') }}"></use>
                            </svg>
                            {{ 'third_party_service.delete.button'|trans()|desc('Delete') }}
                        </button>
                    </form>
                    <button type="button" class="btn ibexa-btn ibexa-btn--secondary" data-bs-dismiss="modal">
                        {{ 'common.cancel'|trans()|desc('Cancel') }}
                    </button>
                {% endblock %}
            {% endembed %}
        {% endfor %}

        {# Delete Cookie Modals - Only for manual cookies #}
        {% for category in policy.categories %}
            {% if not category.isAutoGenerated %}
                {% for cookie in category.cookies %}
                    {% if not cookie.isAutoGenerated %}
                        {# Delete Cookie Modal #}
                    {% embed '@ibexadesign/ui/component/modal/modal.html.twig' with {
                        class: 'ibexa-modal--send-to-trash',
                        no_header: true,
                        id: 'delete-cookie-' ~ cookie.id,
                    } %}
                        {% block body_content %}
                            <p>{{ 'cookie.delete.message'|trans({'%name%': cookie.name})|desc('Delete cookie "%name%"? This action cannot be undone.') }}</p>
                        {% endblock %}
                        {% block footer_content %}
                            <form method="post" action="{{ path('masilia_consent_admin_cookie_delete', {id: cookie.id}) }}"
                                  class="d-inline">
                                <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ cookie.id) }}">
                                <button type="submit" class="btn ibexa-btn ibexa-btn--danger">
                                    <svg class="ibexa-icon ibexa-icon--small">
                                        <use xlink:href="{{ ibexa_icon_path('trash') }}"></use>
                                    </svg>
                                    {{ 'common.delete'|trans()|desc('Delete') }}
                                </button>
                            </form>
                            <button type="button" class="btn ibexa-btn ibexa-btn--secondary" data-bs-dismiss="modal">
                                {{ 'common.cancel'|trans()|desc('Cancel') }}
                            </button>
                        {% endblock %}
                    {% endembed %}
                {% endif %}
            {% endfor %}
            {% endif %}
        {% endfor %}

        {# Activate Policy Modal #}
        {% if not policy.isActive %}
            {% embed '@ibexadesign/ui/component/modal/modal.html.twig' with {
                id: 'activate-policy',
                title: 'policy.activate.confirm'|trans()|desc('Activate Policy'),
            } %}
                {% block body_content %}
                    <p>{{ 'policy.activate.message'|trans({'%version%': policy.version})|desc('Activate policy version %version%? This will deactivate all other policies.') }}</p>
                {% endblock %}
                {% block footer_content %}
                    <form method="post" action="{{ path('masilia_consent_admin_policy_activate', {id: policy.id}) }}"
                          class="d-inline">
                        <input type="hidden" name="_token" value="{{ csrf_token('activate' ~ policy.id) }}">
                        <button type="submit" class="btn ibexa-btn ibexa-btn--primary">
                            <svg class="ibexa-icon ibexa-icon--small">
                                <use xlink:href="{{ ibexa_icon_path('checkmark') }}"></use>
                            </svg>
                            {{ 'policy.activate'|trans()|desc('Activate') }}
                        </button>
                    </form>
                    <button type="button" class="btn ibexa-btn ibexa-btn--secondary" data-bs-dismiss="modal">
                        {{ 'common.cancel'|trans()|desc('Cancel') }}
                    </button>
                {% endblock %}
            {% endembed %}
        {% endif %}
    {% endblock %}
{% endblock %}

{# Macros for reusable components #}
{% macro category_header_tools(category) %}
    <div class="ibexa-extra-actions__btns">
        {% if not category.isAutoGenerated %}
            <a
                    href="{{ path('masilia_consent_admin_cookie_create', {categoryId: category.id}) }}"
                    class="btn ibexa-btn ibexa-btn--tertiary ibexa-btn--small"
                    title="{{ 'cookie.add'|trans()|desc('Add Cookie') }}">
                <svg class="ibexa-icon ibexa-icon--small ibexa-icon--create">
                    <use xlink:href="{{ ibexa_icon_path('create') }}"></use>
                </svg>
                <span class="ibexa-btn__label">{{ 'cookie.add'|trans()|desc('Add Cookie') }}</span>
            </a>
            <a
                    href="{{ path('masilia_consent_admin_category_edit', {id: category.id}) }}"
                    class="btn ibexa-btn ibexa-btn--tertiary ibexa-btn--small"
                    title="{{ 'common.edit'|trans()|desc('Edit') }}">
                <svg class="ibexa-icon ibexa-icon--small ibexa-icon--edit">
                    <use xlink:href="{{ ibexa_icon_path('edit') }}"></use>
                </svg>
                <span class="ibexa-btn__label">{{ 'common.edit'|trans()|desc('Edit') }}</span>
            </a>
            <button
                    type="button"
                    class="btn ibexa-btn ibexa-btn--tertiary ibexa-btn--small"
                    data-bs-toggle="modal"
                    data-bs-target="#delete-category-{{ category.id }}"
                    title="{{ 'common.delete'|trans()|desc('Delete') }}">
                <svg class="ibexa-icon ibexa-icon--small ibexa-icon--trash">
                    <use xlink:href="{{ ibexa_icon_path('trash') }}"></use>
                </svg>
                <span class="ibexa-btn__label">{{ 'common.delete'|trans()|desc('Delete') }}</span>
            </button>
        {% else %}
            <span class="ibexa-label" title="{{ 'category.auto_generated.read_only'|trans|desc('This category is managed by the third-party service') }}">
                <svg class="ibexa-icon ibexa-icon--small ibexa-icon--lock">
                    <use xlink:href="{{ ibexa_icon_path('lock') }}"></use>
                </svg>
                <span class="ibexa-label__text">{{ 'category.read_only'|trans|desc('Read-only') }}</span>
            </span>
        {% endif %}
    </div>
{% endmacro %}

{% macro add_category_button(policy) %}
    <a
            href="{{ path('masilia_consent_admin_category_create', {policyId: policy.id}) }}"
            class="ibexa-btn ibexa-btn--secondary ibexa-btn--small">
        <svg class="ibexa-icon ibexa-icon--small ibexa-icon--create">
            <use xlink:href="{{ ibexa_icon_path('create') }}"></use>
        </svg>
        <span class="ibexa-btn__label">
            {{ 'category.add'|trans()|desc('Add Category') }}
        </span>
    </a>
{% endmacro %}

{% macro add_service_button(policy) %}
    <a
            href="{{ path('masilia_consent_admin_service_create', {policyId: policy.id}) }}"
            class="ibexa-btn ibexa-btn--primary ibexa-btn--small">
        <svg class="ibexa-icon ibexa-icon--small ibexa-icon--create">
            <use xlink:href="{{ ibexa_icon_path('create') }}"></use>
        </svg>
        <span class="ibexa-btn__label">
            {{ 'third_party_service.add.button'|trans()|desc('Add Service') }}
        </span>
    </a>
{% endmacro %}
