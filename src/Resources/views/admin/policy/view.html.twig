{% extends '@ibexadesign/ui/layout.html.twig' %}

{% trans_default_domain 'masilia_consent' %}

{% block body_class %}ibexa-consent-policy-view{% endblock %}

{% block breadcrumbs %}
    {% include '@ibexadesign/ui/breadcrumbs.html.twig' with { items: [
        { value: 'breadcrumb.admin'|trans(domain='messages')|desc('Admin') },
        { value: 'policy.list.title'|trans|desc('Cookie Policies'), url: path('masilia_consent_admin_policy_list') },
        { value: policy.version }
    ]} %}
{% endblock %}

{% block title %}{{ 'policy.view.title'|trans({'%version%': policy.version})|desc('Policy %version%') }}{% endblock %}

{% block header %}
    {% include '@ibexadesign/ui/page_title.html.twig' with {
        title: 'policy.view.title'|trans({'%version%': policy.version})|desc('Cookie Policy - Version %version%'),
        icon_path: ibexa_icon_path('cookie')
    } %}
{% endblock %}

{% block context_menu %}
    {% set menu_items %}
        <li class="ibexa-context-menu__item ibexa-adaptive-items__item">
            <a
                href="{{ path('masilia_consent_admin_policy_list') }}"
                class="btn ibexa-btn ibexa-btn--ghost"
            >
                <svg class="ibexa-icon ibexa-icon--small">
                    <use xlink:href="{{ ibexa_icon_path('back') }}"></use>
                </svg>
                <span class="ibexa-btn__label">
                    {{ 'policy.back_to_list'|trans|desc('Back to list') }}
                </span>
            </a>
        </li>
        <li class="ibexa-context-menu__item ibexa-adaptive-items__item">
            <a
                href="{{ path('masilia_consent_admin_policy_edit', {id: policy.id}) }}"
                class="btn ibexa-btn ibexa-btn--ghost"
            >
                <svg class="ibexa-icon ibexa-icon--small ibexa-icon--edit">
                    <use xlink:href="{{ ibexa_icon_path('edit') }}"></use>
                </svg>
                <span class="ibexa-btn__label">
                    {{ 'policy.edit'|trans|desc('Edit') }}
                </span>
            </a>
        </li>
        {% if not policy.isActive %}
            <li class="ibexa-context-menu__item ibexa-adaptive-items__item">
                <button
                    type="button"
                    class="btn ibexa-btn ibexa-btn--primary"
                    data-bs-toggle="modal"
                    data-bs-target="#activate-policy"
                >
                    <svg class="ibexa-icon ibexa-icon--small">
                        <use xlink:href="{{ ibexa_icon_path('checkmark') }}"></use>
                    </svg>
                    <span class="ibexa-btn__label">
                        {{ 'policy.activate'|trans|desc('Activate') }}
                    </span>
                </button>
            </li>
        {% endif %}
    {% endset %}

    {{ include('@ibexadesign/ui/component/context_menu/context_menu.html.twig', {
        menu_items: menu_items,
    }) }}
{% endblock %}

{% block content %}
    <section class="container ibexa-container">
        {# Policy Information Card #}
        <div class="card ibexa-card ibexa-card--light mb-4">
            <div class="card-header ibexa-card__header">
                <h3 class="ibexa-card__title">
                    {{ 'policy.information'|trans|desc('Policy Information') }}
                </h3>
            </div>
            <div class="card-body ibexa-card__body">
                <div class="row">
                    <div class="col-md-6">
                        <dl class="ibexa-details">
                            <div class="ibexa-details__item">
                                <dt class="ibexa-details__item-label">{{ 'policy.version'|trans|desc('Version') }}</dt>
                                <dd class="ibexa-details__item-value">
                                    <strong>{{ policy.version }}</strong>
                                    {% if policy.isActive %}
                                        <span class="badge bg-success ms-2">{{ 'policy.status.active'|trans|desc('Active') }}</span>
                                    {% endif %}
                                </dd>
                            </div>
                            <div class="ibexa-details__item">
                                <dt class="ibexa-details__item-label">{{ 'policy.last_updated'|trans|desc('Last Updated') }}</dt>
                                <dd class="ibexa-details__item-value">{{ policy.lastUpdated|date('Y-m-d H:i:s') }}</dd>
                            </div>
                        </dl>
                    </div>
                    <div class="col-md-6">
                        <dl class="ibexa-details">
                            <div class="ibexa-details__item">
                                <dt class="ibexa-details__item-label">{{ 'policy.cookie_prefix'|trans|desc('Cookie Prefix') }}</dt>
                                <dd class="ibexa-details__item-value"><code>{{ policy.cookiePrefix }}</code></dd>
                            </div>
                            <div class="ibexa-details__item">
                                <dt class="ibexa-details__item-label">{{ 'policy.expiration_days'|trans|desc('Expiration Days') }}</dt>
                                <dd class="ibexa-details__item-value">{{ policy.expirationDays }} {{ 'policy.days'|trans|desc('days') }}</dd>
                            </div>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        {# Categories Section #}
        <div class="card ibexa-card ibexa-card--light mb-4">
            <div class="card-header ibexa-card__header d-flex justify-content-between align-items-center">
                <h3 class="ibexa-card__title mb-0">
                    {{ 'policy.categories'|trans|desc('Categories') }} ({{ policy.categories|length }})
                </h3>
                <button 
                    type="button" 
                    class="btn ibexa-btn ibexa-btn--primary ibexa-btn--small"
                    data-bs-toggle="modal"
                    data-bs-target="#add-category-modal">
                    <svg class="ibexa-icon ibexa-icon--small ibexa-icon--create">
                        <use xlink:href="{{ ibexa_icon_path('create') }}"></use>
                    </svg>
                    <span class="ibexa-btn__label">
                        {{ 'category.add'|trans|desc('Add Category') }}
                    </span>
                </button>
            </div>
            <div class="card-body ibexa-card__body">
                {% for category in policy.categories %}
                    <div class="ibexa-card ibexa-card--light mb-3">
                        <div class="card-header ibexa-card__header d-flex justify-content-between align-items-center">
                            <h4 class="ibexa-card__title mb-0">
                                {{ category.name }}
                                {% if category.required %}
                                    <span class="badge bg-warning ms-2">{{ 'category.required'|trans|desc('Required') }}</span>
                                {% endif %}
                                {% if category.defaultEnabled %}
                                    <span class="badge bg-info ms-2">{{ 'category.default_enabled'|trans|desc('Default Enabled') }}</span>
                                {% endif %}
                            </h4>
                            <div class="btn-group">
                                <button 
                                    type="button"
                                    class="btn ibexa-btn ibexa-btn--ghost ibexa-btn--small"
                                    data-bs-toggle="modal"
                                    data-bs-target="#edit-category-{{ category.id }}"
                                    title="{{ 'category.edit'|trans|desc('Edit') }}">
                                    <svg class="ibexa-icon ibexa-icon--small ibexa-icon--edit">
                                        <use xlink:href="{{ ibexa_icon_path('edit') }}"></use>
                                    </svg>
                                    <span class="ibexa-btn__label">{{ 'category.edit'|trans|desc('Edit') }}</span>
                                </button>
                                <button 
                                    type="button"
                                    class="btn ibexa-btn ibexa-btn--ghost ibexa-btn--small"
                                    data-bs-toggle="modal"
                                    data-bs-target="#delete-category-{{ category.id }}"
                                    title="{{ 'category.delete'|trans|desc('Delete') }}">
                                    <svg class="ibexa-icon ibexa-icon--small ibexa-icon--trash">
                                        <use xlink:href="{{ ibexa_icon_path('trash') }}"></use>
                                    </svg>
                                    <span class="ibexa-btn__label">{{ 'category.delete'|trans|desc('Delete') }}</span>
                                </button>
                            </div>
                        </div>
                        <div class="card-body ibexa-card__body">
                            <p class="text-muted">{{ category.description }}</p>
                            <p class="mb-0"><small class="text-muted">{{ 'category.identifier'|trans|desc('Identifier') }}: <code>{{ category.identifier }}</code></small></p>
                            
                            <h5 class="mt-3 mb-2">{{ 'category.cookies'|trans({'%count%': category.cookies|length})|desc('Cookies (%count%)') }}</h5>
                            
                            {% set cookie_body_rows = [] %}
                            {% for cookie in category.cookies %}
                                {% set cookie_row_cols = [
                                    { content: '<code>' ~ cookie.name ~ '</code>', raw: true },
                                    { content: cookie.provider },
                                    { content: cookie.purpose },
                                    { content: cookie.expiry },
                                ] %}
                                {% set cookie_body_rows = cookie_body_rows|merge([{ cols: cookie_row_cols }]) %}
                            {% endfor %}

                            {% include '@ibexadesign/ui/component/table/table.html.twig' with {
                                head_cols: [
                                    { content: 'cookie.name'|trans|desc('Name') },
                                    { content: 'cookie.provider'|trans|desc('Provider') },
                                    { content: 'cookie.purpose'|trans|desc('Purpose') },
                                    { content: 'cookie.expiry'|trans|desc('Expiry') },
                                ],
                                body_rows: cookie_body_rows,
                                table_class: 'ibexa-table--sm',
                            } %}
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>

        {# Third-Party Services Section #}
        {% if policy.thirdPartyServices|length > 0 %}
            <div class="card ibexa-card ibexa-card--light mb-4">
                <div class="card-header ibexa-card__header">
                    <h3 class="ibexa-card__title">
                        {{ 'policy.third_party_services'|trans|desc('Third-Party Services') }} ({{ policy.thirdPartyServices|length }})
                    </h3>
                </div>
                <div class="card-body ibexa-card__body">
                    {% set service_body_rows = [] %}
                    {% for service in policy.thirdPartyServices %}
                        {% set service_row_cols = [] %}
                        
                        {% set service_row_cols = service_row_cols|merge([
                            { content: service.name },
                            { content: '<span class="badge bg-secondary">' ~ service.category ~ '</span>', raw: true },
                            { content: service.description },
                        ]) %}

                        {% set col_raw %}
                            <a href="{{ service.privacyPolicyUrl }}" target="_blank" class="btn ibexa-btn ibexa-btn--ghost ibexa-btn--small">
                                <svg class="ibexa-icon ibexa-icon--small">
                                    <use xlink:href="{{ ibexa_icon_path('open-newtab') }}"></use>
                                </svg>
                                {{ 'service.view_policy'|trans|desc('View Policy') }}
                            </a>
                        {% endset %}
                        {% set service_row_cols = service_row_cols|merge([{
                            content: col_raw,
                            raw: true,
                        }]) %}

                        {% set col_raw %}
                            {% if service.enabled %}
                                <span class="badge bg-success">{{ 'service.enabled'|trans|desc('Enabled') }}</span>
                            {% else %}
                                <span class="badge bg-secondary">{{ 'service.disabled'|trans|desc('Disabled') }}</span>
                            {% endif %}
                        {% endset %}
                        {% set service_row_cols = service_row_cols|merge([{
                            content: col_raw,
                            raw: true,
                        }]) %}

                        {% set service_body_rows = service_body_rows|merge([{ cols: service_row_cols }]) %}
                    {% endfor %}

                    {% include '@ibexadesign/ui/component/table/table.html.twig' with {
                        head_cols: [
                            { content: 'service.name'|trans|desc('Name') },
                            { content: 'service.category'|trans|desc('Category') },
                            { content: 'service.description'|trans|desc('Description') },
                            { content: 'service.privacy_policy'|trans|desc('Privacy Policy') },
                            { content: 'service.status'|trans|desc('Status') },
                        ],
                        body_rows: service_body_rows,
                    } %}
                </div>
            </div>
        {% endif %}

        {# Add Category Modal #}
        {% form_theme addCategoryForm '@ibexadesign/ui/form_fields.html.twig' %}
        {% embed '@ibexadesign/ui/component/modal/modal.html.twig' with {
            id: 'add-category-modal',
            title: 'category.add.title'|trans|desc('Add Category'),
            size: 'large',
        } %}
            {% block body_content %}
                {{ form_start(addCategoryForm, {'attr': {'id': 'add-category-form'}}) }}
                    <div class="ibexa-form-block">
                        {{ form_row(addCategoryForm.identifier, { row_attr: { class: 'ibexa-form-field' } }) }}
                        {{ form_row(addCategoryForm.name, { row_attr: { class: 'ibexa-form-field' } }) }}
                        {{ form_row(addCategoryForm.description, { row_attr: { class: 'ibexa-form-field' } }) }}
                        {{ form_row(addCategoryForm.position, { row_attr: { class: 'ibexa-form-field' } }) }}
                        {{ form_row(addCategoryForm.required, { row_attr: { class: 'ibexa-form-field' }, label_attr: {'class': 'checkbox-inline'}}) }}
                        {{ form_row(addCategoryForm.defaultEnabled, { row_attr: { class: 'ibexa-form-field' }, label_attr: {'class': 'checkbox-inline'}}) }}
                    </div>
                {{ form_end(addCategoryForm) }}
            {% endblock %}
            {% block footer_content %}
                <button type="submit" form="add-category-form" class="btn ibexa-btn ibexa-btn--primary">
                    <svg class="ibexa-icon ibexa-icon--small">
                        <use xlink:href="{{ ibexa_icon_path('checkmark') }}"></use>
                    </svg>
                    {{ 'category.form.create'|trans|desc('Create Category') }}
                </button>
                <button type="button" class="btn ibexa-btn ibexa-btn--secondary" data-bs-dismiss="modal">
                    {{ 'category.form.cancel'|trans|desc('Cancel') }}
                </button>
            {% endblock %}
        {% endembed %}

        {# Edit & Delete Modals for Each Category #}
        {% for category in policy.categories %}
            {# Edit Category Modal #}
            {% set editForm = editForms[category.id] %}
            {% form_theme editForm '@ibexadesign/ui/form_fields.html.twig' %}
            {% embed '@ibexadesign/ui/component/modal/modal.html.twig' with {
                id: 'edit-category-' ~ category.id,
                title: 'category.edit.title'|trans({'%name%': category.name})|desc('Edit Category: %name%'),
                size: 'large',
            } %}
                {% block body_content %}
                    {{ form_start(editForm, {'attr': {'id': 'edit-category-form-' ~ category.id}}) }}
                        <div class="ibexa-form-block">
                            {{ form_row(editForm.identifier, { row_attr: { class: 'ibexa-form-field' } }) }}
                            {{ form_row(editForm.name, { row_attr: { class: 'ibexa-form-field' } }) }}
                            {{ form_row(editForm.description, { row_attr: { class: 'ibexa-form-field' } }) }}
                            {{ form_row(editForm.position, { row_attr: { class: 'ibexa-form-field' } }) }}
                            {{ form_row(editForm.required, { row_attr: { class: 'ibexa-form-field' }, label_attr: {'class': 'checkbox-inline'}}) }}
                            {{ form_row(editForm.defaultEnabled, { row_attr: { class: 'ibexa-form-field' }, label_attr: {'class': 'checkbox-inline'}}) }}
                        </div>
                    {{ form_end(editForm) }}
                {% endblock %}
                {% block footer_content %}
                    <button type="submit" form="edit-category-form-{{ category.id }}" class="btn ibexa-btn ibexa-btn--primary">
                        <svg class="ibexa-icon ibexa-icon--small">
                            <use xlink:href="{{ ibexa_icon_path('checkmark') }}"></use>
                        </svg>
                        {{ 'category.form.save'|trans|desc('Save Changes') }}
                    </button>
                    <button type="button" class="btn ibexa-btn ibexa-btn--secondary" data-bs-dismiss="modal">
                        {{ 'category.form.cancel'|trans|desc('Cancel') }}
                    </button>
                {% endblock %}
            {% endembed %}

            {# Delete Category Modal #}
            {% embed '@ibexadesign/ui/component/modal/modal.html.twig' with {
                class: 'ibexa-modal--send-to-trash',
                no_header: true,
                id: 'delete-category-' ~ category.id,
            } %}
                {% block body_content %}
                    <p>{{ 'category.delete.message'|trans({'%name%': category.name})|desc('Delete category "%name%"? This will also delete all associated cookies. This action cannot be undone.') }}</p>
                {% endblock %}
                {% block footer_content %}
                    <form method="post" action="{{ path('masilia_consent_admin_category_delete', {id: category.id}) }}" class="d-inline">
                        <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ category.id) }}">
                        <button type="submit" class="btn ibexa-btn ibexa-btn--danger">
                            <svg class="ibexa-icon ibexa-icon--small">
                                <use xlink:href="{{ ibexa_icon_path('trash') }}"></use>
                            </svg>
                            {{ 'category.delete'|trans|desc('Delete') }}
                        </button>
                    </form>
                    <button type="button" class="btn ibexa-btn ibexa-btn--secondary" data-bs-dismiss="modal">
                        {{ 'category.cancel'|trans|desc('Cancel') }}
                    </button>
                {% endblock %}
            {% endembed %}
        {% endfor %}

        {# Activate Policy Modal #}
        {% if not policy.isActive %}
            {% embed '@ibexadesign/ui/component/modal/modal.html.twig' with {
                id: 'activate-policy',
                title: 'policy.activate.confirm'|trans|desc('Activate Policy'),
            } %}
                {% block body_content %}
                    <p>{{ 'policy.activate.message'|trans({'%version%': policy.version})|desc('Activate policy version %version%? This will deactivate all other policies.') }}</p>
                {% endblock %}
                {% block footer_content %}
                    <form method="post" action="{{ path('masilia_consent_admin_policy_activate', {id: policy.id}) }}" class="d-inline">
                        <button type="submit" class="btn ibexa-btn ibexa-btn--primary">
                            {{ 'policy.activate'|trans|desc('Activate') }}
                        </button>
                    </form>
                    <button type="button" class="btn ibexa-btn ibexa-btn--secondary" data-bs-dismiss="modal">
                        {{ 'policy.cancel'|trans|desc('Cancel') }}
                    </button>
                {% endblock %}
            {% endembed %}
        {% endif %}
    </section>
{% endblock %}
